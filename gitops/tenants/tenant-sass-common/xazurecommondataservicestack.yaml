# xazurecommondataservicestack.yaml
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: xazurecommondataservicestacks.azure.tenark.com
spec:
  group: azure.tenark.com
  names:
    kind: XAzureCommonDataServiceStack
    plural: xazurecommondataservicestacks
  claimNames:
    kind: AzureCommonDataServiceStack
    plural: azurecommondataservicestacks
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                parameters:
                  type: object
                  description: |
                    Parameters define the desired state for a complete Azure Common Data Service Stack,
                    including SQL Server, SQL Database, and Redis Cache, all integrated into an
                    existing Virtual Network and Subnet by its full Azure Resource ID.
                  properties:
                    location:
                      type: string
                      description: Azure region where the resources will be deployed.
                      enum:
                        - EastUS
                        - WestUS
                        - NorthEurope
                        - WestEurope
                        - CentralUS
                        - SoutheastAsia
                    subnetAzureResourceID:
                      type: string
                      description: |
                        The full Azure Resource ID of the existing Subnet to attach the SQL Server (and Redis Cache) to.
                        This ID includes subscription, resource group, VNet name, and subnet name.
                        Example: /subscriptions/uuid/resourceGroups/rg/providers/Microsoft.Network/virtualNetworks/vnet/subnets/subnet
                    administratorLogin:
                      type: string
                      description: Administrator login name for the SQL Server.
                    administratorLoginPasswordSecretRef:
                      type: object
                      description: Secret reference for the SQL Server administrator password.
                      properties:
                        name:
                          type: string
                          description: Name of the Kubernetes Secret.
                        key:
                          type: string
                          description: Key in the Kubernetes Secret holding the password.
                      required:
                        - name
                        - key
                    sqlDatabase:
                      type: object
                      description: Parameters for the Azure SQL Database.
                      properties:
                        collation:
                          type: string
                          description: Collation for the SQL Database.
                          default: SQL_Latin1_General_CP1_CI_AS
                        skuTier:
                          type: string
                          description: Tier of the SQL Database SKU (e.g., Basic, Standard, Premium, GeneralPurpose).
                          enum: [Basic, Standard, Premium, GeneralPurpose, BusinessCritical]
                        skuName:
                          type: string
                          description: Name of the SQL Database SKU (e.g., Basic for Basic tier; GP_Gen5_2 for GeneralPurpose with 2 vCores).
                        capacity:
                          type: integer
                          description: Capacity of the SQL Database SKU (e.g., 5 for Basic tier, or vCores for GeneralPurpose).
                      required:
                        - skuTier
                        - skuName
                        - capacity
                    redisCache:
                      type: object
                      description: Parameters for the Azure Redis Cache instance.
                      properties:
                        skuName:
                          type: string
                          description: Name of the Redis Cache SKU (e.g., Basic, Standard, Premium).
                          enum: [Basic, Standard, Premium]
                        skuFamily:
                          type: string
                          description: Family of the Redis Cache SKU (e.g., C for Basic/Standard, P for Premium).
                          enum: [C, P]
                        skuCapacity:
                          type: integer
                          description: Capacity of the Redis Cache SKU (0-6 for Basic/Standard, 1-5 for Premium).
                        redisVersion: # <-- ADD THIS
                          type: string
                          description: "The version of Redis to use, e.g., '6'."
                      required:
                        - skuName
                        - skuFamily
                        - skuCapacity
                        - redisVersion
                    connectionSecretNamespace:
                      type: string
                      description: Kubernetes namespace where connection secrets will be created.
                      default: default
                  required:
                    - location
                    - subnetAzureResourceID
                    - administratorLogin
                    - administratorLoginPasswordSecretRef
                    - sqlDatabase
                    - redisCache
                    - connectionSecretNamespace
              required:
                - parameters